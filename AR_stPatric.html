<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>St. Patrick's 10 Spot Rally</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --irish-green: #009a49;
            --gold: #ffcd00;
            --dark-green: #00622d;
            --cream: #f8f4e3;
            --parchment: #fdf5e6;
        }

        body { font-family: 'Hiragino Kaku Gothic ProN', sans-serif; background-color: var(--cream); color: var(--dark-green); margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: 0 auto; background: white; border: 4px double var(--gold); border-radius: 15px; padding: 15px; box-sizing: border-box; }
        
        .title-image-container { text-align: center; margin-bottom: 15px; }
        .title-image { width: 100%; max-width: 450px; height: auto; border-radius: 10px; border: 3px solid var(--gold); }

        #map { height: 250px; width: 100%; border-radius: 12px; margin-bottom: 15px; border: 2px solid var(--irish-green); }

        .check-btn { width: 100%; padding: 16px; font-size: 1.1rem; font-weight: bold; cursor: pointer; background: var(--irish-green); color: white; border: none; border-radius: 50px; box-shadow: 0 4px 0 var(--dark-green); margin-bottom: 20px; }

        /* ã‚¹ã‚¿ãƒ³ãƒ—å°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .stamp-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .stamp { background: #fff; border: 1.5px dashed var(--irish-green); border-radius: 8px; padding: 8px 2px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 125px; box-sizing: border-box; }
        .stamp.goal { width: 70%; border: 3px double var(--gold); background: #fffdf0; min-height: 140px; }
        .goal-container { margin-top: 10px; display: flex; justify-content: center; }
        .stamp span { font-size: 10px; font-weight: bold; margin-bottom: 5px; min-height: 28px; display: flex; align-items: center; justify-content: center; }
        
        /* ãƒœã‚¿ãƒ³ */
        .btn-ui { display: block; width: 90%; padding: 6px 0; margin: 2px 0; border-radius: 4px; font-size: 9px; font-weight: bold; text-decoration: none; text-align: center; cursor: pointer; }
        .detail-btn { background: white; color: var(--dark-green); border: 1px solid var(--gold); }
        .ar-btn { background: var(--irish-green); color: white; border: none; display: none; }

        .stamp.active { border-style: solid; background: #e8f5e9; }
        .stamp.active::before { content: 'â˜˜ï¸'; font-size: 16px; }
        .stamp.goal.active::before { content: 'ğŸŒˆ'; font-size: 22px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background-color: var(--parchment); width: 85%; max-width: 400px; padding: 25px; border-radius: 5px; border: 8px double var(--gold); position: relative; max-height: 80vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 5px; right: 10px; font-size: 24px; cursor: pointer; }
        .modal-title { color: var(--irish-green); border-bottom: 2px solid var(--gold); padding-bottom: 10px; margin-top: 10px; }
        .modal-body { line-height: 1.6; font-size: 0.95rem; margin-top: 15px; }

        #status { text-align: center; font-weight: bold; margin-bottom: 10px; font-size: 14px; }
        .custom-marker { font-size: 26px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div class="title-image-container">
        <img src="https://placehold.co/800x350/009a49/ffcd00?text=Shamrock+Rally&font=playfair-display" alt="Shamrock Rally" class="title-image">
    </div>
    
    <div id="map"></div>
    <div id="status">ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</div>
    <button class="check-btn" onclick="checkLocation()">ç¾åœ¨åœ°ã§ã‚¹ã‚¿ãƒ³ãƒ—ï¼</button>

    <div class="stamp-grid" id="stamp-grid-main"></div>
    <div class="goal-container" id="goal-area"></div>
</div>

<div id="infoModal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle" class="modal-title"></h2>
        <div id="modalBody" class="modal-body"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // å…¨10ã‚¹ãƒãƒƒãƒˆã®å®šç¾©ï¼ˆåç§°ãƒ»ä½ç½®ãƒ»è§£èª¬ãƒ»ARãƒªãƒ³ã‚¯ï¼‰
    const targets = {
        "1": { 
            name: "ã‚·ãƒ£ãƒ ãƒ­ãƒƒã‚¯åºƒå ´", lat: 35.7725, lng: 139.6615, arUrl: "#",
            description: "<b>ã€ã‚·ãƒ£ãƒ ãƒ­ãƒƒã‚¯ã¨ã¯ï¼Ÿã€‘</b><br>ä¸‰ã¤è‘‰ã®ã‚¯ãƒ­ãƒ¼ãƒãƒ¼ã®ã“ã¨ã€‚è–ãƒ‘ãƒˆãƒªãƒƒã‚¯ãŒã€ä¸‰ä½ä¸€ä½“ã€ã‚’èª¬ããŸã‚ã«ä½¿ã£ãŸã€ã‚¢ã‚¤ãƒ«ãƒ©ãƒ³ãƒ‰ã®è±¡å¾´ã§ã™ã€‚" 
        },
        "2": { 
            name: "å¦–ç²¾ã®é´å±‹", lat: 35.6812, lng: 139.7671, arUrl: "#",
            description: "<b>ã€ãƒ¬ãƒ—ãƒ©ã‚³ãƒ¼ãƒ³ã®ä¼èª¬ã€‘</b><br>ä¸€äººã§é´ã‚’ä¿®ç†ã—ã¦ã„ã‚‹å¦–ç²¾ã€‚å½¼ã‚’æ•ã¾ãˆãŸã‚‰ã€è™¹ã®éº“ã®é»„é‡‘ã®å£ºã¾ã§æ¡ˆå†…ã•ã›ã¾ã—ã‚‡ã†ï¼" 
        },
        "3": { 
            name: "ãƒ€ãƒ–ãƒªãƒ³ã®æ‰‰", lat: 35.6924, lng: 139.6971, arUrl: "#",
            description: "<b>ã€ã‚«ãƒ©ãƒ•ãƒ«ãªãƒ‰ã‚¢ã€‘</b><br>ãƒ€ãƒ–ãƒªãƒ³ã®è¡—ä¸¦ã¿ã®ç‰¹å¾´ã§ã‚ã‚‹é®®ã‚„ã‹ãªãƒ‰ã‚¢ã€‚é…”ã£ãŸä½äººãŒè‡ªåˆ†ã®å®¶ã‚’é–“é•ãˆãªã„ã‚ˆã†ã«å¡—ã‚Šåˆ†ã‘ãŸã¨ã„ã†èª¬ã‚‚ï¼Ÿ" 
        },
        "4": { 
            name: "ãƒãƒ¼ãƒ—ã®èª¿ã¹", lat: 35.7000, lng: 139.7000, arUrl: "#",
            description: "<b>ã€å›½ç« ã®æ¥½å™¨ã€‘</b><br>ã‚¢ã‚¤ãƒ«ãƒ©ãƒ³ãƒ‰ã¯å›½ç« ã«æ¥½å™¨ï¼ˆãƒãƒ¼ãƒ—ï¼‰ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ä¸–ç•Œã§å”¯ä¸€ã®å›½ã€‚ç¾ã—ã„éŸ³æ¥½ã¯å›½ã®èª‡ã‚Šã§ã™ã€‚" 
        },
        "5": { 
            name: "ã‚±ãƒ«ãƒˆã®çµã³ç›®", lat: 35.7100, lng: 139.7100, arUrl: "#",
            description: "<b>ã€æ°¸é ã®ã‚·ãƒ³ãƒœãƒ«ã€‘</b><br>é€”åˆ‡ã‚Œã‚‹ã“ã¨ã®ãªã„ã‚±ãƒ«ãƒˆã®çµã³ç›®æ¨¡æ§˜ã¯ã€æ°¸é ã€ã‚„ã€çµ†ã€ã‚’è±¡å¾´ã™ã‚‹ã€ã‚¢ã‚¤ãƒ«ãƒ©ãƒ³ãƒ‰ã®ä¼çµ±æ–‡æ§˜ã§ã™ã€‚" 
        },
        "6": { 
            name: "å·¨äººã®çŸ³é“", lat: 35.7200, lng: 139.7200, arUrl: "#",
            description: "<b>ã€ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒ„ãƒ»ã‚³ãƒ¼ã‚ºã‚¦ã‚§ãƒ¼ã€‘</b><br>4ä¸‡å€‹ã‚‚ã®å…­è§’å½¢ã®çŸ³æŸ±ãŒä¸¦ã¶ä¸æ€è­°ãªæµ·å²¸ã€‚å·¨äººãŒã‚¹ã‚³ãƒƒãƒˆãƒ©ãƒ³ãƒ‰ã¾ã§æ¸¡ã‚‹ãŸã‚ã«ä½œã£ãŸã¨ã„ã†ä¼èª¬ãŒã‚ã‚Šã¾ã™ã€‚" 
        },
        "7": { 
            name: "ã‚¹ãƒ­ãƒ³ãƒãƒ£ï¼", lat: 35.7300, lng: 139.7300, arUrl: "#",
            description: "<b>ã€ä¹¾æ¯ã®è¨€è‘‰ã€‘</b><br>ã‚²ãƒ¼ãƒ«èªã§ã€å¥åº·ã«ï¼ã€ã¨ã„ã†æ„å‘³ã®ä¹¾æ¯ã®æŒ¨æ‹¶ã€‚ãƒ‘ãƒ–ã§èª°ã‹ã¨çŸ¥ã‚Šåˆã£ãŸã‚‰ã‚¹ãƒ­ãƒ³ãƒãƒ£ï¼ã¨å£°ã‚’ã‹ã‘ã¾ã—ã‚‡ã†ã€‚" 
        },
        "8": { 
            name: "é»’ã„ç³ã®ãƒ“ãƒ¼ãƒ«", lat: 35.7400, lng: 139.7400, arUrl: "#",
            description: "<b>ã€ã‚®ãƒã‚¹ã®ç§˜å¯†ã€‘</b><br>å®Ÿã¯ã‚®ãƒã‚¹ãƒ“ãƒ¼ãƒ«ã¯ã€çœŸã£é»’ã€ã§ã¯ãªãã€é€ã‹ã—ã¦è¦‹ã‚‹ã¨ã€æ·±ã„ãƒ«ãƒ“ãƒ¼è‰²ã€ã‚’ã—ã¦ã„ã‚‹ã®ã‚’çŸ¥ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ" 
        },
        "9": { 
            name: "ç¾Šã®ä¸˜", lat: 35.7500, lng: 139.7500, arUrl: "#",
            description: "<b>ã€ã‚¦ãƒ¼ãƒ«ã®å³¶ã€‘</b><br>ã‚¢ãƒ©ãƒ³ã‚»ãƒ¼ã‚¿ãƒ¼ãªã©ã€ã‚¢ã‚¤ãƒ«ãƒ©ãƒ³ãƒ‰ã¯é«˜å“è³ªãªã‚¦ãƒ¼ãƒ«ã§ã‚‚æœ‰åã€‚äººå£ã‚ˆã‚Šã‚‚ç¾Šã®æ–¹ãŒå¤šã„ã¨è¨€ã‚ã‚Œã‚‹ã»ã©èº«è¿‘ãªå­˜åœ¨ã§ã™ã€‚" 
        },
        "10": { 
            name: "ğŸŒˆ è™¹ã®éº“ã®ã‚´ãƒ¼ãƒ«", lat: 35.7600, lng: 139.7600, arUrl: "#",
            description: "<b>ã€ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼ã€‘</b><br>ãŠã‚ã§ã¨ã†ï¼ã“ã‚Œã§ã‚ãªãŸã‚‚ã‚¢ã‚¤ãƒ«ãƒ©ãƒ³ãƒ‰ãƒ»ãƒã‚¹ã‚¿ãƒ¼ã€‚3æœˆ17æ—¥ã®ãƒ•ã‚§ã‚¹ãƒ†ã‚£ãƒãƒ«ã‚’å¿ƒã‚†ãã¾ã§æ¥½ã—ã¿ã¾ã—ã‚‡ã†ï¼" 
        }
    };

    let map, userMarker, markers = {};
    const storageKey = 'rally_stpatty_full_v1';

    function init() {
        const gridMain = document.getElementById('stamp-grid-main');
        const goalArea = document.getElementById('goal-area');

        for (let i = 1; i <= 10; i++) {
            const div = document.createElement('div');
            div.id = `stamp-${i}`;
            div.className = (i === 10) ? 'stamp goal' : 'stamp';
            div.innerHTML = `
                <span>${targets[i].name}</span>
                <div class="btn-ui detail-btn" onclick="openModal('${i}')">ğŸ” è§£èª¬ã‚’èª­ã‚€</div>
                <a href="${targets[i].arUrl}" id="ar-link-${i}" class="btn-ui ar-btn" target="_blank">â˜˜ï¸ Open AR!</a>
            `;
            if (i <= 9) gridMain.appendChild(div);
            else goalArea.appendChild(div);
        }

        map = L.map('map').setView([targets["1"].lat, targets["1"].lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        for (let id in targets) {
            markers[id] = L.marker([targets[id].lat, targets[id].lng], {
                icon: L.divIcon({ className: 'custom-marker', html: (id=="10"?'ğŸš©':'ğŸ“'), iconSize: [30, 30] })
            }).addTo(map);
        }
        userMarker = L.circleMarker([0,0], { color: '#007bff', radius: 7 }).addTo(map);

        updateDisplay();
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                userMarker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
            }, null, { enableHighAccuracy: true });
        }
    }

    function openModal(id) {
        document.getElementById('modalTitle').innerText = targets[id].name;
        document.getElementById('modalBody').innerHTML = targets[id].description;
        document.getElementById('infoModal').style.display = 'flex';
    }
    function
